%% Non-Linear Trajectory Plotter

clear all
close all
%% Define System
%Get sys for the model and then use [y,t,x] = initial(sys,x0) to plot!


%% Drive Train Sub system
% States - 

% omega_r - Rotor angular velocity [rad/s]
% omega_g - Generator angular velocity [rad/s]
% feta_delta - Drive train torsional angle [rad]

%feta_fa - tower top foreaft bending angle (in direction of wind)
%omega_fa - Tower top foreaft bending angular velocity (in direction of wind)

% feta_beta - Blade-pitch [deg] (actually 90 minus pitch)
% omega_beta - Blade-pitch rate [deg/s] (actually minus pitch rate)

lambda_r = 2.025; % Max rotor velocity [rad/s]
lambda_delta = 441.42e-3; % Ultimate load limit of drive train torsion [rad]
lambda_fa = 9.54e-3; % rad/s

rho = 1.22521;
A = 11.88e3;
A = 1.245e4;
R = 61.5;
L = 87.6; %Tower Length
v_wind = 25;
%Kp = 200;

%% Solve the ODEs
% 1) - omega_r_0 = 1.26, pitch = 23, foreaft  = 0.15, wind = 25
% 2) omega_r_0 = 1.26, pitch = 23, wind = 35
dt = 0.01;
tspan = 0:dt:20;
omega_r_0 = 1.26; %region 3 = 12.1 rpm = 1.267 rad/s
ref = 12.1*2*pi/60;
pitch_initial = 23;
x0 = [omega_r_0 (omega_r_0)*97 0 0/L 0/L 90-pitch_initial -8];

%Solve for trajectory
%[t,y] = ode45(@sys_shut1,tspan,x0);

[t,y] = ode45(@sys_shut_fault,tspan,x0);

leny = length(y);
lenys = length(y);

% plot(y(1:leny,1),y(1:leny,2))

%% OpenFAST shutdown trajectories
%[Rt_speed,Gen_speed,Torsion_ang,Flap_x,Edge_x,Top_4aft_disp,Pitch_1,TSR,Cq,Ct,Aero_thrust,Aero_torq,Rt_wind];

FAST = importdata('5MW_35_17.1.mat');
FAST = FAST';
t_start = 10*20;
t_end = 30*20;

t_FAST = (0:0.05:(t_end-t_start)/20);

Rt_speed_FAST = [1.26710903694788;1.26501464184549;1.26920343205028;1.27339222225506;1.27129782715267;1.26396744429429;1.25768425898711;1.25558986388472;1.25558986388472;1.25663706143592;1.25977865408951;1.26396744429429;1.26815623449908;1.27129782715267;1.27443941980626;1.27758101245985;1.27653381490865;1.27129782715267;1.26710903694788;1.26501464184549;1.26501464184549;1.26396744429429;1.26292024674310;1.26606183939669;1.27129782715267;1.27548661735746;1.27758101245985;1.27758101245985;1.27653381490865;1.27443941980626;1.27129782715267;1.26710903694788;1.26396744429429;1.26187304919190;1.26082585164070;1.26292024674310;1.26710903694788;1.27025062960147;1.27129782715267;1.27129782715267;1.27129782715267;1.27025062960147;1.26815623449908;1.26396744429429;1.26082585164070;1.25977865408951;1.26082585164070;1.26292024674310;1.26501464184549;1.26815623449908;1.27129782715267;1.27339222225506;1.27443941980626;1.27339222225506;1.27129782715267;1.26815623449908;1.26606183939669;1.26501464184549;1.26501464184549;1.26606183939669;1.26815623449908;1.27129782715267;1.27339222225506;1.27548661735746;1.27548661735746;1.27339222225506;1.27129782715267;1.26920343205028;1.26710903694788;1.26501464184549;1.26396744429429;1.26501464184549;1.26710903694788;1.27025062960147;1.27234502470387;1.27443941980626;1.27443941980626;1.27443941980626;1.27443941980626;1.27234502470387;1.27025062960147;1.26920343205028;1.26920343205028;1.26920343205028;1.27129782715267;1.27339222225506;1.27443941980626;1.27653381490865;1.27758101245985;1.27758101245985;1.27653381490865;1.27443941980626;1.27129782715267;1.26920343205028;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26920343205028;1.27025062960147;1.27129782715267;1.27025062960147;1.26920343205028;1.26815623449908;1.26606183939669;1.26501464184549;1.26292024674310;1.26292024674310;1.26292024674310;1.26396744429429;1.26501464184549;1.26710903694788;1.26815623449908;1.26920343205028;1.26920343205028;1.26920343205028;1.26815623449908;1.26710903694788;1.26710903694788;1.26606183939669;1.26710903694788;1.26815623449908;1.27025062960147;1.27129782715267;1.27234502470387;1.27339222225506;1.27339222225506;1.27234502470387;1.27129782715267;1.27025062960147;1.26920343205028;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26920343205028;1.27025062960147;1.27129782715267;1.27129782715267;1.27129782715267;1.27025062960147;1.26920343205028;1.26815623449908;1.26710903694788;1.26710903694788;1.26710903694788;1.26815623449908;1.27025062960147;1.27129782715267;1.27234502470387;1.27339222225506;1.27234502470387;1.27234502470387;1.27129782715267;1.26920343205028;1.26815623449908;1.26815623449908;1.26710903694788;1.26710903694788;1.26815623449908;1.26815623449908;1.26920343205028;1.26920343205028;1.26815623449908;1.26710903694788;1.26606183939669;1.26501464184549;1.26396744429429;1.26292024674310;1.26292024674310;1.26292024674310;1.26396744429429;1.26396744429429;1.26501464184549;1.26501464184549;1.26606183939669;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26606183939669;1.26710903694788;1.26815623449908;1.26920343205028;1.27025062960147;1.27129782715267;1.27129782715267;1.27129782715267;1.27129782715267;1.27025062960147;1.27025062960147;1.27025062960147;1.26920343205028;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.26920343205028;1.26815623449908;1.26710903694788;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26710903694788;1.26710903694788;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26606183939669;1.26606183939669;1.26501464184549;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26396744429429;1.26396744429429;1.26501464184549;1.26501464184549;1.26606183939669;1.26710903694788;1.26815623449908;1.26920343205028;1.26920343205028;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27129782715267;1.27129782715267;1.27129782715267;1.27129782715267;1.27025062960147;1.26920343205028;1.26920343205028;1.26710903694788;1.26710903694788;1.26606183939669;1.26606183939669;1.26501464184549;1.26501464184549;1.26606183939669;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26396744429429;1.26501464184549;1.26501464184549;1.26501464184549;1.26606183939669;1.26606183939669;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26606183939669;1.26606183939669;1.26710903694788;1.26710903694788;1.26815623449908;1.26815623449908;1.26920343205028;1.26920343205028;1.26920343205028;1.26920343205028;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.26920343205028;1.26920343205028;1.26815623449908;1.26710903694788;1.26710903694788;1.26606183939669;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26396744429429;1.26396744429429;1.26396744429429;1.26292024674310;1.26292024674310;1.26292024674310;1.26292024674310;1.26396744429429;1.26396744429429;1.26396744429429;1.26501464184549;1.26606183939669;1.26606183939669;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26920343205028;1.26920343205028;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.26920343205028;1.26920343205028;1.26920343205028;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26710903694788;1.26710903694788;1.26710903694788;1.26606183939669;1.26501464184549;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26292024674310;1.26292024674310;1.26292024674310;1.26292024674310;1.26292024674310;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26501464184549;1.26606183939669;1.26606183939669;1.26710903694788;1.26710903694788;1.26815623449908;1.26815623449908;1.26815623449908;1.26920343205028;1.26920343205028;1.26920343205028;1.26920343205028;1.26920343205028;1.26920343205028;1.26920343205028;1.26920343205028;1.26920343205028;1.26920343205028;1.26920343205028;1.26815623449908;1.26815623449908;1.26815623449908;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26815623449908;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26606183939669;1.26606183939669;1.26606183939669;1.26501464184549;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26501464184549;1.26501464184549;1.26501464184549;1.26606183939669;1.26606183939669;1.26710903694788;1.26815623449908;1.26815623449908;1.26920343205028;1.26920343205028;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.26920343205028;1.26920343205028;1.26815623449908;1.26815623449908;1.26710903694788;1.26710903694788;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26710903694788;1.26606183939669;1.26606183939669;1.26606183939669;1.26606183939669;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26606183939669;1.26606183939669;1.26606183939669;1.26710903694788;1.26710903694788;1.26815623449908;1.26920343205028;1.26920343205028;1.26920343205028;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.27025062960147;1.26920343205028;1.26920343205028;1.26920343205028;1.26815623449908;1.26710903694788;1.26606183939669;1.26606183939669;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26501464184549;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26396744429429;1.26501464184549;1.26501464184549;1.26710903694788;1.26920343205028;1.27234502470387;1.27862821001105;1.29328897572780;1.32470490226370;1.35297923614600;1.36345121165797;1.36554560676036;1.37392318716994;1.38648955778430;1.39800873084746;1.41057510146182;1.43256625003695;1.45979338636806;1.48492612759678;1.50691727617190;1.53309721495182;1.55613556107814;1.56660753659011;1.56556033903891;1.56451314148772;1.56660753659011;1.56660753659011;1.56346594393652;1.56556033903891;1.57498511699968;1.58964588271644;1.60116505577960;1.60849543863797;1.61477862394515;1.61792021659874;1.61477862394515;1.60640104353558;1.59488187047242;1.58336269740926;1.57184352434609;1.56451314148772;1.56032435128293;1.55927715373173;1.55822995618054;1.55508836352695;1.55299396842455;1.54775798066857;1.53833320270780;1.52367243699105;1.50482288106951;1.48597332514797;1.46712376922643;1.44827421330489;1.42942465738336;1.41476389166660;1.40219752105224;1.39277274309148;1.38230076757951;1.37078159451635;1.35821522390199;1.34355445818523;1.32575209981489;1.30690254389335;1.28805298797182;1.26920343205028;1.25244827123113;1.23883470306558;1.22940992510481;1.22207954224643;1.21684355449045;1.21265476428566;1.20846597408087;1.20427718387609;1.19694680101771;1.18542762795455;1.17181405978899;1.15715329407224;1.14144533080429;1.12469016998515;1.10898220671720;1.09536863855164;1.08280226793728;1.07233029242532;1.06290551446455;1.05243353895258;1.04321820050205;1.03337454352080;1.02269312849860;1.01127867519055;0.999864221882512;0.989078087105187;0.979443869634178;0.971589888000203;0.965830301468622;0.961955670529195;0.959756555671682;0.959442396406323;0.959965995181921;0.960280154447280;0.959756555671682;0.958081039589767;0.955044166691297;0.950960096241630;0.945305229465169;0.938079566361912;0.930016145217698;0.922057443828604;0.914727060970228;0.907396678111852;0.900485174273955;0.894097269211655;0.888232962924954;0.882263936883134;0.876085471331074;0.869488126758535;0.862367183410398;0.854513201776424;0.846659220142449;0.838805238508475;0.831055976629620;0.823306714750765;0.815871612137269;0.809693146585209;0.804247719318987;0.798802292052765;0.792937985766064;0.786864239969124;0.780685774417064;0.773669550824046;0.765710849434952;0.756914390004901;0.747594331799251;0.738169553838482;0.728640056122593;0.719424717672063;0.710732977997131;0.702669556852917;0.695234454239421;0.688532389911763;0.682458644114823;0.676489618073002;0.670520592031181;0.664761005499600;0.658896699212899;0.652927673171079;0.646853927374138;0.640466022311839;0.634287556759779;0.628632689983318;0.623291982472215;0.618579593491830;0.614390803287044;0.610620892102736;0.607060420428668;0.603395228999480;0.599520598060052;0.594912928834787;0.589362781813445;0.583184316261385;0.576063372913248;0.567999951769035;0.559098772583864;0.549988153888453;0.540668095682804;0.531348037477154;0.522551578047102;0.514383437147769;0.506738895024034;0.499199072655418;0.492182849062401;0.485585504489862;0.478883440162204;0.471762496814067;0.464013234935212;0.455845094035879;0.447153354360947;0.437728576400178;0.427780199663810;0.418145982192801;0.408825923987152;0.399505865781502;0.390499966841211;0.382227106186758;0.374687283818143;0.367356900959767;0.360235957611630;0.353533893283971;0.347041268466553;0.340234484383775;0.333218260790757;0.326202037197740;0.319290533359843;0.312483749277065;0.305781684949407;0.299498499642227;0.293634193355526;0.288398205599543;0.283790536374278;0.279287586904133;0.275203516454466;0.271328885515039;0.267558974330731;0.263684343391303;0.259809712451876;0.255830361757329;0.251746291307662;0.247557501102876;0.243473430653209;0.239703519468901;0.236247767549952;0.233106174896363;0.229650422977414;0.226194671058465;0.223053078404875;0.220225645016645;0.217084052363055;0.213523580688986;0.209648949749559;0.205564879299892;0.201271369339986;0.196454260604482;0.191637151868977;0.187134202398832;0.182317093663328;0.177499984927823;0.172892315702558;0.168389366232413;0.163781697007148;0.159069308026763;0.154671078311738;0.150377568351831;0.145874618881686;0.141371669411541;0.137078159451635;0.132470490226370;0.127758101245985;0.122940992510481;0.118333323285216;0.113516214549711;0.108803825569327;0.104290404123669;0.0999864221882511;0.0956824402528331;0.0913784583174151;0.0872001400881407;0.0831789014915458;0.0790529431398312;0.0747803771309490;0.0703716754404114;0.0659001418968019;0.0613657765001206;0.0568732990054872;0.0525483731190453;0.0484747746448905;0.0448305271667263;0.0418041262437682;0.0394688757045998;0.0377305277696134;0.0365681384877852;0.0358560441529715;0.0353848052549330;0.0349659262344544;0.0345156312874399;0.0339710885608176;0.0331752184219082;0.0320337730911039;0.0307038322010842;0.0293843632865765;0.0282324459802603;0.0272585522576474;0.0265778738493697;0.0262846585350346;0.0264522101432261;0.0269653369433124;0.0276879032536380;0.0286827409272748;0.0297718263805193;0.0307247761521082;0.0314578144379458;0.0320023571645680;0.0323269884054390;0.0324421801360706;0.0324421801360706;0.0323793482829988;0.0323688763074868;0.0325259559401663;0.0328924750830851;0.0334056018831715;0.0339815605363296;0.0345261032629518;0.0349763982099664;0.0352800854998134;0.0353429173528852;0.0350706459895741;0.0344213835078322;0.0334893776872672;0.0324107642095347;0.0313112067807783;0.0302011773765099;0.0291016199477534;0.0281172542496287;0.0273213841107192;0.0266511776779534;0.0260019151962115;0.0253107648124218;0.0245463106000483;0.0236666646570431;0.0226613550078944;0.0215513256036260;0.0203261044687260;0.0191427712358738;0.0180851017091652;0.0171426239130883;0.0163572257496909;0.0158336269740926;0.0155613556107814;0.0154775798066857;0.0154985237577096;0.0155718275862934;0.0156765473414131;0.0157079632679490;0.0156660753659011;0.0155404116597575;0.0153623880760541;0.0151424765903028;0.0149958689331353;0.0150587007862071;0.0153728600515661;0.0158859868516524;0.0166294971130020;0.0176243347866387;0.0188600278970507;0.0201794968115584;0.0214361338729944;0.0226299390813585;0.0236666646570431;0.0244834787469765;0.0250908533266705;0.0255202043226611;0.0258343635880201;0.0260647470492833;0.0263160744615705;0.0266302337269295;0.0269862808943363;0.0274156318903269;0.0278763988128534;0.0283371657353799;0.0287141568538107;0.0289759562416099;0.0291016199477534;0.0290911479722415;0.0289235963640500;0.0285989651231791;0.0281486701761645;0.0276355433760782;0.0271224165759919;0.0265883458248816;0.0260228591472355;0.0254154845675414;0.0247871660368235;0.0241379035550816;0.0234258092202679;0.0225880511793106;0.0216246294322097;0.0205774318810131;0.0195407063053285;0.0185144527051558;0.0174986710804951;0.0166085531619780;0.0159069308026763;0.0153728600515661;0.0149958689331353;0.0147864294228960;0.0146817096677763;0.0146188778147045;0.0145665179371447;0.0145036860840729;0.0143780223779293;0.0140952790391062;0.0138963115043789;0.0137706477982353;0.0136135681655558;0.0135297923614600;0.0136659280431156;0.0140429191615464;0.0145769899126566;0.0152890842474703;0.0161687301904755;0.0171635678641122;0.0182107654153088;0.0192789069175294;0.0202842165666781;0.0211324465831473;0.0217921810404012;0.0222843638894636;0.0226822989589183;0.0230069301997893;0.0232687295875884;0.0234886410733397;0.0237609124366508;0.0241169596040576;0.0244939507224884;0.0248395259143833;0.0251432132042303;0.0254154845675414;0.0256039801267568;0.0256877559308525;0.0256458680288047;0.0255097323471491;0.0253212367879337;0.0250803813511585;0.0247976380123354;0.0244939507224884;0.0241588475061055;0.0238132723142106;0.0234153372447559;0.0229022104446696;0.0222948358649756;0.0216141574566978;0.0208182873177884;0.0199176974237593;0.0189647476521704;0.0180117978805815;0.0170797920600165;0.0162315620435473;0.0154566358556618;0.0148806772025037;0.0144722701575370;0.0141476389166660;0.0139172554554028;0.0138125357002831;0.0137287598961874;0.0136030961900438;0.0134355445818523;0.0132784649491729;0.0130376095123976;0.0127758101245985;0.0125977865408951;0.0125140107367993;0.0125349546878233;0.0126710903694788;0.0130480814879096;0.0136135681655558;0.0143151905248575;0.0151320046147908;0.0160430664843319;0.0169855442804088;0.0178651902234140;0.0186610603623234;0.0193312667950892;0.0198443935951755;0.0202109127380943;0.0204831841014054;0.0207240395381807;0.0209334790484200;0.0211429185586593;0.0213733020199226;0.0216665173342576;0.0220225645016644;0.0223890836445833;0.0227032429099422;0.0229650422977414;0.0231744818079807;0.0233001455141243;0.0233315614406602;0.0232477856365645;0.0230907060038850;0.0229126824201816;0.0226927709344303;0.0224309715466311;0.0221272842567841;0.0217817090648892;0.0214151899219704;0.0209753669504679;0.0204517681748696;0.0198234496441516;0.0191218272848499;0.0183678450479883;0.0175824468845909;0.0167761047701695;0.0159907066067720;0.0152786122719584;0.0146502937412404;0.0141895268187139;0.0137078159451635;0.0133936566798045;0.0132365770471250;0.0131213853164934;0.0129643056838139;0.0128072260511344;0.0126396744429429;0.0124302349327036;0.0121265476428566;0.0118752202305694;0.0117181405978899;0.0116134208427703;0.0115820049162344;0.0117390845489139;0.0121474915938805;0.0126815623449908;0.0132889369246848;0.0140429191615464;0.0148911491780156;0.0157184352434609;0.0164410015537866;0.0170797920600165;0.0176452787376627;0.0180746297336533;0.0183678450479883;0.0185877565337396;0.0188181399950029;0.0190275795052422;0.0192474909909935;0.0195197623543046;0.0198339216196636;0.0201690248360465;0.0205146000279413;0.0208601752198362;0.0211638625096832;0.0213837739954345;0.0214989657260662;0.0215513256036260;0.0215199096770901;0.0213942459709465;0.0211848064607072;0.0209334790484200;0.0206612076851089;0.0203470484197499;0.0199910012523430;0.0196035381584003;0.0191637151868977;0.0186820043133473;0.0181479335622370;0.0175719749090789;0.0169541283538729;0.0163048658721310;0.0156346594393652;0.0149958689331353;0.0144199102799772;0.0138858395288669;0.0133936566798045;0.0129957216103498;0.0126292024674310;0.0124092909816797;0.0122522113490002;0.0120532438142728;0.0118123883774976;0.0116238928182822;0.0114458692345788;0.0111631258957557;0.0109222704589805;0.0107966067528369;0.0107547188507891;0.0107651908263010;0.0109117984834685;0.0112573736753634;0.0117181405978899;0.0122522113490002;0.0128700579042062;0.0135716802635079;0.0142628306472977;0.0148702052269917;0.0154147479536139;0.0159174027781883;0.0163467537741789;0.0166818569905618;0.0169541283538729;0.0172054557661601;0.0174672551539593;0.0177395265172704;0.0180117978805815;0.0183259571459405;0.0186715323378353;0.0190066355542182;0.0193312667950892;0.0196140101339123;0.0198234496441516;0.0199491133502952;0.0200014732278550;0.0199805292768311;0.0198653375461995;0.0196873139624960;0.0194359865502089;0.0191532432113858;0.0188495559215388;0.0184935087541319;0.0181165176357011;0.0177081105907345;0.0172787595947439;0.0168284646477293;0.0163362817986669;0.0158231549985806;0.0152890842474703;0.0147340695453361;0.0141581108921780;0.0136449840920917;0.0131632732185412;0.0127025062960147;0.0121684355449045;0.0118228603530096;0.0116029488672583;0.0113411494794592;0.0110269902141002;0.0108070787283489;0.0106499990956694;0.0104573147462492];
FAST(1,t_start:t_end);
Gen_speed_FAST = FAST(2,t_start:t_end);
Torsion_FAST = FAST(3,t_start:t_end);
Flap_FAST = FAST(4,t_start:t_end);
Edge_FAST = FAST(5,t_start:t_end);
fa_disp_FAST = FAST(6,t_start:t_end);
Pitch_FAST = FAST(7,t_start:t_end);

TSR_FAST = FAST(8,t_start:t_end);
Cq_FAST = FAST(9,t_start:t_end);
Ct_FAST = FAST(10,t_start:t_end);
Rt_thrust_FAST = FAST(11,t_start:t_end);
Rt_torq_FAST = FAST(12,t_start:t_end);
v_w_eff_FAST = FAST(13,t_start:t_end);

% Thrust_FAST = FAST(14,t_start:t_end);
% Torq_FAST = FAST(15,t_start:t_end);

%% Plot States etc..
%plot Rotor Speed
figure
plot(t,y(1:lenys,1))
hold on
plot(t_FAST,Rt_speed_FAST(29*20:20*(29+20))')
xlabel('Time (s)','fontsize',16)
title('Rotor Speed (rad/s)','fontsize',18)
ylim([0 1.8])
legend('Model','OpenFAST','fontsize',16)
%Plot pitch to time

%Plot Pitch and TSR
figure
plot(t,90-y(1:leny,6))
hold on

%Plot TSR (including wind change)
v_w_eff = v_wind - L*y(1:leny,5);
TSR_plot =  R*y(1:leny,1)./v_w_eff;
hold on
plot(t_FAST,Pitch_FAST)
xlabel('Time (s)','fontsize',16)
title('Pitch (deg)','fontsize',18)
legend('Model','OpenFAST','fontsize',16)
ylim([0 95])

figure
plot(t,TSR_plot)
hold on
plot(t_FAST,TSR_FAST)
xlabel('Time (s)')
ylabel('TSR')
legend('Model','OpenFAST')

figure
plot(t,y(1:leny,3))
hold on
plot(t_FAST,Torsion_FAST/97)
hold on
%plot(t,zeros(1,leny)+441.42e-3)
xlabel('Time (s)','fontsize',16)
title('Torsion Angle (deg)','fontsize',18)
%ylim([-0.5 0.5])

legend('Model','OpenFAST','fontsize',16)

%Plot tower top displacement
figure
plot(t,y(1:leny,4)*L)
hold on
%plot(t,zeros(1,leny)-lambda_fa*L)
hold on
plot(t_FAST,fa_disp_FAST)
xlabel('Time (s)','fontsize',16)
title('Tower Top Foreaft Displacement (m)','fontsize',18)
legend('Model','OpenFAST','fontsize',16)


%Plot tower top velocity
figure
plot(t,y(1:leny,5)*L)
xlabel('Time (s)')
ylabel('Tower Top Foreaft Velocity (m/s)')
title('Tower Top Velocity at Shutdown')

%Plot effective wind speed
figure
plot(t,v_w_eff)
hold on
plot(t_FAST,v_w_eff_FAST)
xlabel('Time (s)')
ylabel('Effective Wind Speed (m/s)')
legend('Model','OpenFAST')

ylim([0 40])
% 
% % Plot trajectory of foreaft disp to velocity
% 
% figure
% plot(y(1:leny,4)*L,y(1:leny,5)*L)
% xlabel('Top Displacement (m)')
% ylabel('Top Velocity (m/s)')



%% Pitch vs TSR plot (Cq & Ct)

C_q_Fit = [-0.00845641270737012,0.000687609914773001,0.0179412949214744,-7.81146089582775e-06,-0.000708685201549979,-0.00111642539872539];
%C_t_Fit = [-0.298870172594411,0.0186831045303255,0.212534047298766,-0.000191128780351677,-0.00713429256157738,-0.0103237054607148];

C_q_Fit = 2*[-0.0240889231402065,0.00108816365174505,0.0234530529270319,-9.14549613647725e-06,-0.000613719856304388,-0.00158790611519949];
C_t_Fit = 0.5*[-0.407703867241420,0.0153920094483093,0.244017959995536,-0.000121004122118517,-0.00687654914812738,-0.0124188251797834];
%C_t_Fit = [-0.333531105111448,0.0189722913931486,0.207893385576849,-0.000170297441388086,-0.00787753211141654,-0.00916740700259423];

%C_t_Fit = [0.00918804524480671,0.000782586502128278,-0.0517312182789156,-0.000166805956250679,0.00735234124804766,0.0441117150136366,5.79049353535173e-06,2.96517482111935e-05,-0.00280604951721465,-0.00477915112883495,-7.20507343258882e-08,-3.54345369856179e-06,-2.72309109021075e-05,0.000216502706458144,0.000199339950801924,3.01021710386354e-10,1.85338627464466e-08,9.22217860114289e-07,4.48175377371743e-07,-6.67681367985541e-06,-2.42788530536534e-06];
%C_q_Fit = [0.0887009882823798, -0.000994478306871089, -0.0111240840652831, 0 0 0];

% Find values of TSR and Coefficient values from simulation
TSR_traj = TSR_plot;
Pitch_traj = 90 - y(1:leny,6);
Pitch_traj = 23 + Pitch_traj*0;
Cq = C_q_Fit(1) + C_q_Fit(2).*Pitch_traj + C_q_Fit(3).*TSR_traj + C_q_Fit(4).*Pitch_traj.^2 +C_q_Fit(5).*Pitch_traj.*TSR_traj + C_q_Fit(6).*TSR_traj.^2;
Ct = C_t_Fit(1) + C_t_Fit(2).*Pitch_traj + C_t_Fit(3).*TSR_traj + C_t_Fit(4).*Pitch_traj.^2 +C_t_Fit(5).*Pitch_traj.*TSR_traj + C_t_Fit(6).*TSR_traj.^2;
% Ct = polyval2(C_t_Fit,Pitch_traj(1:1000),TSR_traj(1:1000));
% Ct = Ct(1,:);
% Ct(1001:6001) = 0;

% Plot Tau_aero and F_aero
figure
F_aero = 0.5*rho*A*v_w_eff.^2.*Ct;
Tau_aero = 0.5*rho*A*R*v_w_eff.^2.*Cq;

plot(t,F_aero/1e6)
hold on
plot(t_FAST,Rt_thrust_FAST/1e6)
%hold on
%plot(t_FAST,Thrust_FAST/1e3)
xlabel('Time (s)','fontsize',16)
title('Thrust (MN)','fontsize',18)
legend('Model','OpenFAST','fontsize',16)

figure
plot(t,Tau_aero/1e6)
hold on
plot(t_FAST,Rt_torq_FAST/1e6)
%hold on
%plot(t_FAST,Torq_FAST/1e3)
xlabel('Time (s)','fontsize',16)
title('Torque (MNm)','fontsize',18)
legend('Model','OpenFAST','fontsize',16)

%Plot Ct and Cq
figure
F_aero = 0.5*rho*A*v_w_eff.^2.*Ct;
Tau_aero = 0.5*rho*A*R*v_w_eff.^2.*Cq;

plot(t,Ct)
hold on
plot(t_FAST,Ct_FAST)
xlabel('Time (s)')
ylabel('Thrust Coefficient')
legend('Model','OpenFAST')


figure
plot(t,Cq)
hold on
plot(t_FAST,Cq_FAST)
xlabel('Time (s)')
ylabel('Torque Coefficient')
legend('Model','OpenFAST')
% 
% figure
% plot(t,y(1:leny,8))
% hold on
% plot(t_FAST,Flap_FAST)
% xlabel('Time (s)')
% ylabel('Flapwise Blade Tip Displacement')
% legend('Model','FAST')
% 
% figure
% plot(t,y(1:leny,11)*R)
% hold on
% plot(t_FAST,Edge_FAST)
% xlabel('Time (s)')
% ylabel('Edgewise Blade Tip Displacement')
% legend('Model','FAST')



leny = length(Ct_FAST);
% Plot mesh of Cq
TSR = (0:0.5:10);
Pitch = 0:5:100;

%Ct_mesh = polyval2(C_t_Fit,Pitch,TSR);

[TSR,Pitch] = meshgrid(TSR,Pitch);
Cq_mesh =  C_q_Fit(1) + C_q_Fit(2).*Pitch + C_q_Fit(3).*TSR + C_q_Fit(4).*Pitch.^2 +C_q_Fit(5).*Pitch.*TSR + C_q_Fit(6).*TSR.^2;
Ct_mesh =  C_t_Fit(1) + C_t_Fit(2).*Pitch + C_t_Fit(3).*TSR + C_t_Fit(4).*Pitch.^2 +C_t_Fit(5).*Pitch.*TSR + C_t_Fit(6).*TSR.^2;

figure
mesh(TSR,Pitch,Cq_mesh,'FaceAlpha','0.5')
hold on
% %Plot trajectory
% plot3(TSR_traj,Pitch_traj,Cq+0.001,'r')
% hold on
% %Plot start and end with circle and cross
% plot3(TSR_traj(1),Pitch_traj(1),Cq(1)+0.001,'mo')
% hold on
% plot3(TSR_traj(leny),Pitch_traj(leny),Cq(leny)+0.001,'rx')
hold on
plot3(TSR_FAST,Pitch_FAST,Cq_FAST)
hold on
plot3(TSR_FAST(1),Pitch_FAST(1),Cq_FAST(1)+0.001,'mo')
hold on
plot3(TSR_FAST(leny),Pitch_FAST(leny),Cq_FAST(leny)+0.001,'rx')
%Plot boundary for TSR (based on omega r)

lengt = length(Pitch);
CO(:,:,1) = ones(lengt); % red
CO(:,:,2) = zeros(lengt); % green
CO(:,:,3) = zeros(lengt); % blue

% Plot unsafe boundary
%mesh(zeros(lengt)+2.025*R/v_wind,Pitch,TSR/50-0.1,CO)
% hold on

xlabel('TSR')
ylabel('Pitch (deg)')
zlabel('Torque Coefficient')
legend('Approximated Surface','OpenFAST')
xlim([-0.1 4])
ylim([0 95])
zlim([-0.06 0.06])

%% Plot Ct Mesh plot
figure
mesh(TSR,Pitch,Ct_mesh,'FaceAlpha','0.5')
hold on
% %Plot trajectory
% plot3(TSR_traj,Pitch_traj,Ct+0.001,'r')
% hold on
% %Plot start and end with circle and cross
% plot3(TSR_traj(1),Pitch_traj(1),Ct(1)+0.001,'mo')
% hold on
% plot3(TSR_traj(leny),Pitch_traj(leny),Ct(leny)+0.001,'rx')
 hold on
plot3(TSR_FAST,Pitch_FAST,Ct_FAST)
hold on
plot3(TSR_FAST(1),Pitch_FAST(1),Ct_FAST(1)+0.001,'mo')
hold on
plot3(TSR_FAST(leny),Pitch_FAST(leny),Ct_FAST(leny)+0.001,'rx')


% Plot unsafe boundary
%mesh(zeros(lengt)+2.025*R/v_wind,Pitch,TSR/5-1,CO)
% hold on
% v_wind = 20;
% mesh(zeros(lengt)+2.025*R/v_wind,pitch,TSR/100-0.05,CO)

xlabel('TSR')
ylabel('Pitch (deg)')
zlabel('Thrust Coefficient')
legend('Approximated Surface','OpenFAST')
xlim([-0.1 4])
ylim([0 95])
zlim([-0.1 0.1])

